#!/bin/bash

if [ $1 ]; then
       pname=$1
       echo "项目名称为$pname"
       else
       pname='web'
       echo "没有定义项目名称, 默认为$pname"
fi

echo "**********************************************************************************************************************"
echo "强制删除已有$1容器"
docker rm -f $1

echo "**********************************************************************************************************************"
echo "强制删除已有$1镜像"
docker rmi -f $1

echo "**********************************************************************************************************************"
echo "创建$1镜像"
docker build -t $1 .


if [ ! -d ../$1/nginx ] ; then
  echo "**********************************************************************************************************************"
  echo "Nginx配置目录不存在，创建并复制默认配置文件..."
  mkdir ../$1/nginx
  cp conf/default.conf ../$1/nginx/default.conf
fi


if [ ! -d ../$1/www ] ; then
  echo "**********************************************************************************************************************"
  echo "www目录不存在，创建并复制默认站点主页文件..."
  mkdir -p ../$1/www/default
  cp conf/index.php ../$1/www/default/
fi


if [ ! -d ../$1/logs ] ; then
  echo "**********************************************************************************************************************"
  echo "logs目录不存在，创建..."
  mkdir ../$1/logs
fi


if [ ! -d ../$1/mysql ] ; then
  echo "**********************************************************************************************************************"
  echo "mysql目录不存，创建..."
  mkdir ../$1/mysql
fi

echo "**********************************************************************************************************************"
echo "根据镜像创建容器，运行并挂载目录"
if [ ! $2 ]; then  
       $2='80'  
fi  
docker run -d \
  -p 80:$2 \
  --name $1 \
  -v $PWD/../$1/nginx:/etc/nginx/conf.d \
  -v $PWD/../$1/mysql:/var/lib/mysql \
  -v $PWD/../$1/logs:/web/logs \
  -v $PWD/../$1/www:/web/www \
  $1

echo "**********************************************************************************************************************"
echo "显示当前的镜像列表"
docker images

echo "**********************************************************************************************************************"
echo "显示当前容器的进程"
docker ps

echo "**********************************************************************************************************************"
echo "输出$1容器的日志"
docker logs $1
